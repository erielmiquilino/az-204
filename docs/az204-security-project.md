# Projeto AZ-204: Sistema de Gest√£o de Documentos Corporativos

## üìã Vis√£o Geral do Projeto

**Nome:** SecureDocManager
**Objetivo:** Sistema web para gest√£o segura de documentos corporativos com diferentes n√≠veis de acesso

### üéØ Finalidade do Projeto

Este projeto foi desenvolvido especificamente como **projeto de estudos para a certifica√ß√£o Azure AZ-204**, focando na se√ß√£o **"Implementar a seguran√ßa do Azure"** que representa 15-20% do exame.

O objetivo √© criar um ambiente pr√°tico onde posso aplicar e consolidar todos os conceitos de seguran√ßa do Azure de forma integrada, ao inv√©s de estudar cada tecnologia isoladamente. Atrav√©s da implementa√ß√£o de um sistema real e funcional, busco:

- **Experi√™ncia hands-on** com todas as tecnologias de seguran√ßa do Azure
- **Compreens√£o pr√°tica** de como essas tecnologias trabalham juntas
- **Portf√≥lio t√©cnico** demonstr√°vel para futuros processos seletivos
- **Prepara√ß√£o s√≥lida** para os cen√°rios de prova da AZ-204
- **Documenta√ß√£o completa** do processo de aprendizado

### Funcionalidades Principais

- Upload e download de documentos
- Controle de acesso baseado em fun√ß√µes (Admin, Manager, Employee)
- Assinatura digital de documentos
- Auditoria de acessos
- Integra√ß√£o com Microsoft Graph para dados do usu√°rio
- Configura√ß√µes seguras da aplica√ß√£o

## üéØ Tecnologias que Ser√£o Exploradas

### ‚úÖ Autentica√ß√£o e Autoriza√ß√£o

- **Microsoft Entra ID** para autentica√ß√£o de usu√°rios
- **Plataforma Microsoft Identity** para SSO
- **Claims-based authorization** com diferentes roles

### ‚úÖ Armazenamento Seguro

- **Azure Key Vault** para chaves, segredos e certificados
- **App Configuration** para configura√ß√µes da aplica√ß√£o
- **Managed Identity** para acesso seguro aos recursos

### ‚úÖ Controle de Acesso

- **Shared Access Signatures (SAS)** para documentos
- **Microsoft Graph API** para informa√ß√µes do usu√°rio

### ‚úÖ Arquitetura

- **Frontend:** React.js com MSAL.js
- **Backend:** ASP.NET Core Web API
- **Storage:** Azure Blob Storage
- **Database:** Azure Cosmos DB (NoSQL) + Azure SQL Database

---

## üöÄ Roteiro de Implementa√ß√£o

### **Fase 1: Configura√ß√£o da Infraestrutura Azure**

#### 1.1 Cria√ß√£o dos Recursos Base

```PowerShell
$RG_NAME = "rg-securedocmanager"
$LOCAL = "brazilsouth"
$STORAGE_NAME = "stsecuredocmanager"

az group create --name $RG_NAME --location $LOCAL

# Criar Storage Account
az storage account create `
    --name $STORAGE_NAME `
    --resource-group $RG_NAME `
    --location $LOCAL `
    --sku Standard_LRS

# Criar Azure SQL Database
az sql server create `
    --name "sql-securedocmanager" `
    --resource-group $RG_NAME `
    --location $LOCAL `
    --admin-user sqladmin `
    --admin-password "2139uni1j1i5WU8ai;"

az sql db create `
    --resource-group $RG_NAME `
    --server "sql-securedocmanager" `
    --name db-documents `
    --backup-storage-redundancy Local `
    --service-objective Basic

# Criar Azure Cosmos DB
az cosmosdb create `
    --name "cosmos-securedocmanager" `
    --resource-group $RG_NAME `
    --locations regionName=$LOCAL `
    --default-consistency-level Session `
    --enable-free-tier true

# Criar database e container no Cosmos DB
az cosmosdb sql database create `
    --account-name "cosmos-securedocmanager" `
    --resource-group $RG_NAME `
    --name DocumentsDB

az cosmosdb sql container create `
    --account-name cosmos-securedocmanager `
    --resource-group $RG_NAME `
    --database-name DocumentsDB `
    --name Documents `
    --partition-key-path "/departmentId" `
    --throughput 400
```

#### 1.2 Configura√ß√£o do Azure Key Vault

```PowerShell
# Criar Key Vault
az keyvault create `
    --name kv-securedocmanager `
    --resource-group $RG_NAME `
    --location $LOCAL `
    --enabled-for-deployment true `
    --enabled-for-template-deployment true

# Defina o Object ID (OID) da identidade que voc√™ quer atribuir a fun√ß√£o
$assigneeObjectId = "9b42cb6e-f529-4d9a-957a-b4b317143886"

# Defina o escopo do Key Vault (o caminho completo do recurso)
# Certifique-se de que este caminho corresponde exatamente ao seu Key Vault
$keyVaultScope = "/subscriptions/2e894cd1-92d7-4c3a-8282-abd1b455b834/resourcegroups/rg-securedocmanager/providers/Microsoft.KeyVault/vaults/kv-securedocmanager"

# Atribua a fun√ß√£o 'Key Vault Secrets Officer'
# Esta fun√ß√£o concede permiss√µes para gerenciar segredos (criar, ler, atualizar, excluir)
az role assignment create `
    --role "Key Vault Secrets Officer" `
    --assignee $assigneeObjectId `
    --scope $keyVaultScope

# Adicionar segredos iniciais
az keyvault secret set `
    --vault-name kv-securedocmanager `
    --name "DatabaseConnectionString" `
    --value "Server=sql-securedocmanager.database.windows.net;Database=db-documents;..."

az keyvault secret set \
    --vault-name kv-securedocmanager \
    --name "CosmosDBConnectionString" \
    --value "AccountEndpoint=https://cosmos-securedocmanager.documents.azure.com:443/;AccountKey=..."

az keyvault secret set \
    --vault-name kv-securedocmanager \
    --name "StorageConnectionString" \
    --value "DefaultEndpointsProtocol=https;AccountName=stsecuredocmanager;..."
```

#### 1.3 Configura√ß√£o do App Configuration

```PowerShell
# Criar App Configuration
az appconfig create `
    --name appconfig-securedocmanager `
    --resource-group $RG_NAME `
    --location $LOCAL `
    --sku standard

# Adicionar configura√ß√µes
az appconfig kv set `
    --name appconfig-securedocmanager `
    --key "Documents:MaxFileSizeMB" `
    --value "10"

az appconfig kv set `
    --name appconfig-securedocmanager `
    --key "Documents:AllowedExtensions" `
    --value "pdf,docx,xlsx,pptx"
```

---

### **Fase 2: Configura√ß√£o do Microsoft Entra ID**

#### 2.1 Registro da Aplica√ß√£o Web API

```PowerShell
# Criar app registration para API
$adminRoleId = [guid]::NewGuid().ToString()
$managerRoleId = [guid]::NewGuid().ToString()
$employeeRoleId = [guid]::NewGuid().ToString()

$appRolesArray = @(
    @{
        allowedMemberTypes = @("User");
        description = "Administrator access";
        displayName = "Admin";
        id = $adminRoleId;
        isEnabled = $true;
        value = "Admin"
    },
    @{
        allowedMemberTypes = @("User");
        description = "Manager access";
        displayName = "Manager";
        id = $managerRoleId;
        isEnabled = $true;
        value = "Manager"
    },
    @{
        allowedMemberTypes = @("User");
        description = "Employee access";
        displayName = "Employee";
        id = $employeeRoleId;
        isEnabled = $true;
        value = "Employee"
    }
)

# Criar arquivo tempor√°rio
$tempFile = [System.IO.Path]::GetTempFileName() + ".json"
$appRolesArray | ConvertTo-Json | Out-File -FilePath $tempFile -Encoding UTF8

# Usar o arquivo
az ad app create `
    --display-name "SecureDocManager-API" `
    --identifier-uris "api://securedocmanager-api" `
    --app-roles "@$tempFile"

# Limpar arquivo tempor√°rio
Remove-Item $tempFile
```

#### 2.2 Registro da Aplica√ß√£o Frontend

```PowerShell
# Criar app registration para SPA
az ad app create `
    --display-name "SecureDocManager-SPA" `
    --spa-redirect-uris "http://localhost:3000" `
    --required-resource-accesses '[
        {
            "resourceAppId": "[API-APP-ID]",
            "resourceAccess": [
                {
                    "id": "[SCOPE-ID]",
                    "type": "Scope"
                }
            ]
        },
        {
            "resourceAppId": "00000003-0000-0000-c000-000000000000",
            "resourceAccess": [
                {
                    "id": "e1fe6dd8-ba31-4d61-89e7-88639da4683d",
                    "type": "Scope"
                }
            ]
        }
    ]'
```

#### 2.3 Configura√ß√£o de Permiss√µes Microsoft Graph

- User.Read (para perfil b√°sico)
- User.ReadBasic.All (para listar usu√°rios da organiza√ß√£o)
- Directory.Read.All (para informa√ß√µes do diret√≥rio)

---

### **Fase 3: Implementa√ß√£o do Backend (ASP.NET Core)**

#### 3.1 Estrutura do Projeto

```text
SecureDocManager.API/
‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îú‚îÄ‚îÄ AuthController.cs
‚îÇ   ‚îú‚îÄ‚îÄ DocumentsController.cs
‚îÇ   ‚îî‚îÄ‚îÄ UsersController.cs
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îú‚îÄ‚îÄ IDocumentService.cs
‚îÇ   ‚îú‚îÄ‚îÄ DocumentService.cs
‚îÇ   ‚îú‚îÄ‚îÄ IKeyVaultService.cs
‚îÇ   ‚îú‚îÄ‚îÄ KeyVaultService.cs
‚îÇ   ‚îú‚îÄ‚îÄ IGraphService.cs
‚îÇ   ‚îú‚îÄ‚îÄ GraphService.cs
‚îÇ   ‚îú‚îÄ‚îÄ ICosmosService.cs
‚îÇ   ‚îî‚îÄ‚îÄ CosmosService.cs
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îú‚îÄ‚îÄ Document.cs
‚îÇ   ‚îú‚îÄ‚îÄ User.cs
‚îÇ   ‚îú‚îÄ‚îÄ CosmosDocument.cs
‚îÇ   ‚îî‚îÄ‚îÄ DTOs/
‚îú‚îÄ‚îÄ Data/
‚îÇ   ‚îú‚îÄ‚îÄ ApplicationDbContext.cs
‚îÇ   ‚îî‚îÄ‚îÄ CosmosDbContext.cs
‚îî‚îÄ‚îÄ Program.cs
```

#### 3.2 Configura√ß√£o Principal (Program.cs)

```csharp
// Configurar Managed Identity
builder.Services.AddAzureClients(clientBuilder =>
{
    clientBuilder.AddKeyVaultClient(new Uri("https://kv-securedocmanager.vault.azure.net/"));
    clientBuilder.AddConfigurationClient(new Uri("https://appconfig-securedocmanager.azconfig.io"));
    clientBuilder.UseCredential(new DefaultAzureCredential());
});

// Configurar Authentication
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddMicrosoftIdentityWebApi(builder.Configuration.GetSection("AzureAd"));

// Configurar Authorization
builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("AdminOnly", policy => policy.RequireRole("Admin"));
    options.AddPolicy("ManagerOrAdmin", policy => policy.RequireRole("Manager", "Admin"));
});

// Configurar Cosmos DB
builder.Services.AddSingleton<CosmosClient>(serviceProvider =>
{
    var connectionString = builder.Configuration["CosmosDBConnectionString"];
    return new CosmosClient(connectionString);
});
```

#### 3.3 Implementa√ß√£o do Key Vault Service

```csharp
public class KeyVaultService : IKeyVaultService
{
    private readonly SecretClient _secretClient;
    
    public KeyVaultService(SecretClient secretClient)
    {
        _secretClient = secretClient;
    }
    
    public async Task<string> GetSecretAsync(string secretName)
    {
        var secret = await _secretClient.GetSecretAsync(secretName);
        return secret.Value.Value;
    }
    
    public async Task<string> GetConnectionStringAsync()
    {
        return await GetSecretAsync("DatabaseConnectionString");
    }
}
```

#### 3.4 Implementa√ß√£o SAS Tokens para Blob Storage

```csharp
public class DocumentService : IDocumentService
{
    public async Task<string> GenerateDownloadUrlAsync(string documentId, string userRole)
    {
        var blobClient = GetBlobClient(documentId);
        
        var sasBuilder = new BlobSasBuilder
        {
            BlobContainerName = "documents",
            BlobName = documentId,
            Resource = "b",
            ExpiresOn = DateTimeOffset.UtcNow.AddHours(1)
        };
        
        // Diferentes permiss√µes baseadas no role
        if (userRole == "Admin" || userRole == "Manager")
        {
            sasBuilder.SetPermissions(BlobSasPermissions.Read | BlobSasPermissions.Write);
        }
        else
        {
            sasBuilder.SetPermissions(BlobSasPermissions.Read);
        }
        
        return blobClient.GenerateSasUri(sasBuilder).ToString();
    }
}
```

#### 3.5 Integra√ß√£o com Microsoft Graph

```csharp
public class GraphService : IGraphService
{
    private readonly GraphServiceClient _graphClient;
    
    public async Task<User> GetUserProfileAsync(string userId)
    {
        return await _graphClient.Users[userId]
            .Request()
            .Select(u => new { u.DisplayName, u.Mail, u.Department, u.JobTitle })
            .GetAsync();
    }
    
    public async Task<IEnumerable<User>> GetUsersInDepartmentAsync(string department)
    {
        return await _graphClient.Users
            .Request()
            .Filter($"department eq '{department}'")
            .GetAsync();
    }
}
```

#### 3.6 Servi√ßo Cosmos DB

```csharp
public class CosmosService : ICosmosService
{
    private readonly CosmosClient _cosmosClient;
    private readonly Container _container;
    
    public CosmosService(CosmosClient cosmosClient)
    {
        _cosmosClient = cosmosClient;
        _container = _cosmosClient.GetContainer("DocumentsDB", "Documents");
    }
    
    public async Task<CosmosDocument> CreateDocumentAsync(CosmosDocument document)
    {
        var response = await _container.CreateItemAsync(document, new PartitionKey(document.DepartmentId));
        return response.Resource;
    }
    
    public async Task<CosmosDocument> GetDocumentAsync(string id, string departmentId)
    {
        try
        {
            var response = await _container.ReadItemAsync<CosmosDocument>(id, new PartitionKey(departmentId));
            return response.Resource;
        }
        catch (CosmosException ex) when (ex.StatusCode == HttpStatusCode.NotFound)
        {
            return null;
        }
    }
    
    public async Task<IEnumerable<CosmosDocument>> GetDocumentsByDepartmentAsync(string departmentId, string userRole)
    {
        var queryDefinition = new QueryDefinition(
            "SELECT * FROM c WHERE c.departmentId = @departmentId AND c.accessLevel <= @accessLevel")
            .WithParameter("@departmentId", departmentId)
            .WithParameter("@accessLevel", GetAccessLevel(userRole));
            
        var query = _container.GetItemQueryIterator<CosmosDocument>(queryDefinition);
        var results = new List<CosmosDocument>();
        
        while (query.HasMoreResults)
        {
            var response = await query.ReadNextAsync();
            results.AddRange(response.ToList());
        }
        
        return results;
    }
    
    private int GetAccessLevel(string role)
    {
        return role switch
        {
            "Admin" => 3,
            "Manager" => 2,
            "Employee" => 1,
            _ => 0
        };
    }
}
```

---

### **Fase 4: Implementa√ß√£o do Frontend (React + MSAL)**

#### 4.1 Configura√ß√£o MSAL

```javascript
// src/authConfig.js
export const msalConfig = {
    auth: {
        clientId: "YOUR-SPA-CLIENT-ID",
        authority: "https://login.microsoftonline.com/YOUR-TENANT-ID",
        redirectUri: "http://localhost:3000"
    },
    cache: {
        cacheLocation: "sessionStorage",
        storeAuthStateInCookie: false,
    }
};

export const loginRequest = {
    scopes: ["api://securedocmanager-api/access_as_user", "User.Read"]
};
```

#### 4.2 Componente de Autentica√ß√£o

```javascript
// src/components/AuthWrapper.js
import { useMsal } from "@azure/msal-react";

const AuthWrapper = ({ children }) => {
    const { instance, accounts } = useMsal();
    
    const handleLogin = () => {
        instance.loginPopup(loginRequest);
    };
    
    if (accounts.length === 0) {
        return (
            <div>
                <button onClick={handleLogin}>Login com Microsoft</button>
            </div>
        );
    }
    
    return children;
};
```

#### 4.3 Hook para Chamadas de API

```javascript
// src/hooks/useApiCall.js
export const useApiCall = () => {
    const { instance, accounts } = useMsal();
    
    const callApi = async (url, options = {}) => {
        const request = {
            scopes: ["api://securedocmanager-api/access_as_user"],
            account: accounts[0]
        };
        
        const response = await instance.acquireTokenSilent(request);
        
        return fetch(url, {
            ...options,
            headers: {
                ...options.headers,
                'Authorization': `Bearer ${response.accessToken}`
            }
        });
    };
    
    return { callApi };
};
```

---

### **Fase 5: Implementa√ß√£o de Managed Identity**

#### 5.1 Configura√ß√£o no App Service

```bash
# Habilitar System Assigned Managed Identity
az webapp identity assign \
    --name app-securedocmanager \
    --resource-group $RG_NAME

# Dar permiss√µes ao Key Vault
az keyvault set-policy \
    --name kv-securedocmanager \
    --object-id [MANAGED-IDENTITY-OBJECT-ID] \
    --secret-permissions get list

# Dar permiss√µes ao App Configuration
az role assignment create \
    --assignee [MANAGED-IDENTITY-OBJECT-ID] \
    --role "App Configuration Data Reader" \
    --scope /subscriptions/[SUB-ID]/resourceGroups/rg-securedocmanager/providers/Microsoft.AppConfiguration/configurationStores/appconfig-securedocmanager
```

#### 5.2 C√≥digo para Usar Managed Identity

```csharp
// Configura√ß√£o no Program.cs
builder.Configuration.AddAzureAppConfiguration(options =>
{
    options.Connect(new Uri("https://appconfig-securedocmanager.azconfig.io"), 
                   new DefaultAzureCredential())
           .UseFeatureFlags();
});

// Configura√ß√£o do Key Vault
builder.Configuration.AddAzureKeyVault(
    new Uri("https://kv-securedocmanager.vault.azure.net/"),
    new DefaultAzureCredential());
```

---

### **Fase 6: Funcionalidades Avan√ßadas**

#### 6.1 Assinatura Digital de Documentos

```csharp
public class DocumentSigningService
{
    private readonly KeyVaultService _keyVaultService;
    
    public async Task<byte[]> SignDocumentAsync(byte[] document, string certificateName)
    {
        var certificate = await _keyVaultService.GetCertificateAsync(certificateName);
        
        // Implementar assinatura digital usando o certificado do Key Vault
        using var rsa = certificate.GetRSAPrivateKey();
        var signature = rsa.SignData(document, HashAlgorithmName.SHA256, RSASignaturePadding.Pkcs1);
        
        return signature;
    }
}
```

#### 6.2 Auditoria de Acessos

```csharp
public class AuditService
{
    public async Task LogAccessAsync(string userId, string documentId, string action)
    {
        var auditLog = new AuditLog
        {
            UserId = userId,
            DocumentId = documentId,
            Action = action,
            Timestamp = DateTime.UtcNow,
            IpAddress = GetClientIpAddress()
        };
        
        await _context.AuditLogs.AddAsync(auditLog);
        await _context.SaveChangesAsync();
    }
}
```

---

## üìö Estrutura do Reposit√≥rio GitHub

```text
SecureDocManager/
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ setup-guide.md
‚îÇ   ‚îú‚îÄ‚îÄ architecture.md
‚îÇ   ‚îî‚îÄ‚îÄ api-documentation.md
‚îú‚îÄ‚îÄ infrastructure/
‚îÇ   ‚îú‚îÄ‚îÄ azure-resources.bicep
‚îÇ   ‚îî‚îÄ‚îÄ deployment-scripts/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ SecureDocManager.API/
‚îÇ   ‚îú‚îÄ‚îÄ SecureDocManager.Web/
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ ci-cd.yml
‚îÇ       ‚îî‚îÄ‚îÄ infrastructure.yml
‚îî‚îÄ‚îÄ docker/
    ‚îú‚îÄ‚îÄ Dockerfile.api
    ‚îî‚îÄ‚îÄ Dockerfile.web
```

---

## üéì Pontos de Aprendizado para AZ-204

### ‚úÖ Implementar autentica√ß√£o e autoriza√ß√£o de usu√°rio

- **Aplicado:** Sistema completo de login com Microsoft Entra ID
- **Conceitos:** JWT tokens, Claims, Roles, Policies

### ‚úÖ Microsoft Identity Platform

- **Aplicado:** MSAL.js no frontend, Microsoft.Identity.Web no backend
- **Conceitos:** OAuth 2.0, OpenID Connect, Token lifecycle

### ‚úÖ Shared Access Signatures

- **Aplicado:** URLs tempor√°rias para download de documentos
- **Conceitos:** Time-based access, Permission levels, Blob SAS

### ‚úÖ Microsoft Graph

- **Aplicado:** Busca de perfil do usu√°rio e informa√ß√µes organizacionais
- **Conceitos:** Graph SDK, Scoped permissions, Batch requests

### ‚úÖ App Configuration & Key Vault

- **Aplicado:** Configura√ß√µes din√¢micas e secrets seguros
- **Conceitos:** Configuration management, Secret rotation, Feature flags

### ‚úÖ Managed Identity

- **Aplicado:** Acesso sem credenciais a recursos Azure
- **Conceitos:** System vs User assigned, Role assignments, DefaultAzureCredential

---
