# Projeto AZ-204: Sistema de Gest√£o de Documentos Corporativos

## üìã Vis√£o Geral do Projeto

**Nome:** SecureDocManager
**Objetivo:** Sistema web para gest√£o segura de documentos corporativos com diferentes n√≠veis de acesso

### Funcionalidades Principais:
- Upload e download de documentos
- Controle de acesso baseado em fun√ß√µes (Admin, Manager, Employee)
- Assinatura digital de documentos
- Auditoria de acessos
- Integra√ß√£o com Microsoft Graph para dados do usu√°rio
- Configura√ß√µes seguras da aplica√ß√£o

## üéØ Tecnologias que Ser√£o Exploradas

### ‚úÖ Autentica√ß√£o e Autoriza√ß√£o
- **Microsoft Entra ID** para autentica√ß√£o de usu√°rios
- **Plataforma Microsoft Identity** para SSO
- **Claims-based authorization** com diferentes roles

### ‚úÖ Armazenamento Seguro
- **Azure Key Vault** para chaves, segredos e certificados
- **App Configuration** para configura√ß√µes da aplica√ß√£o
- **Managed Identity** para acesso seguro aos recursos

### ‚úÖ Controle de Acesso
- **Shared Access Signatures (SAS)** para documentos
- **Microsoft Graph API** para informa√ß√µes do usu√°rio

### ‚úÖ Arquitetura
- **Frontend:** React.js com MSAL.js
- **Backend:** ASP.NET Core Web API
- **Storage:** Azure Blob Storage
- **Database:** Azure SQL Database

---

## üöÄ Roteiro de Implementa√ß√£o

### **Fase 1: Configura√ß√£o da Infraestrutura Azure**

#### 1.1 Cria√ß√£o dos Recursos Base
```bash
# Criar Resource Group
az group create --name rg-securedocmanager --location brazilsouth

# Criar Storage Account
az storage account create \
    --name stsecuredocmanager \
    --resource-group rg-securedocmanager \
    --location brazilsouth \
    --sku Standard_LRS

# Criar Azure SQL Database
az sql server create \
    --name sql-securedocmanager \
    --resource-group rg-securedocmanager \
    --location brazilsouth \
    --admin-user sqladmin \
    --admin-password "SuaSenhaSegura123!"

az sql db create \
    --resource-group rg-securedocmanager \
    --server sql-securedocmanager \
    --name db-documents \
    --service-objective Basic
```

#### 1.2 Configura√ß√£o do Azure Key Vault
```bash
# Criar Key Vault
az keyvault create \
    --name kv-securedocmanager \
    --resource-group rg-securedocmanager \
    --location brazilsouth \
    --enabled-for-deployment true \
    --enabled-for-template-deployment true

# Adicionar segredos iniciais
az keyvault secret set \
    --vault-name kv-securedocmanager \
    --name "DatabaseConnectionString" \
    --value "Server=sql-securedocmanager.database.windows.net;Database=db-documents;..."

az keyvault secret set \
    --vault-name kv-securedocmanager \
    --name "StorageConnectionString" \
    --value "DefaultEndpointsProtocol=https;AccountName=stsecuredocmanager;..."
```

#### 1.3 Configura√ß√£o do App Configuration
```bash
# Criar App Configuration
az appconfig create \
    --name appconfig-securedocmanager \
    --resource-group rg-securedocmanager \
    --location brazilsouth \
    --sku standard

# Adicionar configura√ß√µes
az appconfig kv set \
    --name appconfig-securedocmanager \
    --key "Documents:MaxFileSizeMB" \
    --value "10"

az appconfig kv set \
    --name appconfig-securedocmanager \
    --key "Documents:AllowedExtensions" \
    --value "pdf,docx,xlsx,pptx"
```

---

### **Fase 2: Configura√ß√£o do Microsoft Entra ID**

#### 2.1 Registro da Aplica√ß√£o Web API
```bash
# Criar app registration para API
az ad app create \
    --display-name "SecureDocManager-API" \
    --identifier-uris "api://securedocmanager-api" \
    --app-roles '[
        {
            "allowedMemberTypes": ["User"],
            "description": "Administrator access",
            "displayName": "Admin",
            "id": "$(uuidgen)",
            "isEnabled": true,
            "value": "Admin"
        },
        {
            "allowedMemberTypes": ["User"],
            "description": "Manager access",
            "displayName": "Manager",
            "id": "$(uuidgen)",
            "isEnabled": true,
            "value": "Manager"
        },
        {
            "allowedMemberTypes": ["User"],
            "description": "Employee access",
            "displayName": "Employee",
            "id": "$(uuidgen)",
            "isEnabled": true,
            "value": "Employee"
        }
    ]'
```

#### 2.2 Registro da Aplica√ß√£o Frontend
```bash
# Criar app registration para SPA
az ad app create \
    --display-name "SecureDocManager-SPA" \
    --spa-redirect-uris "http://localhost:3000" \
    --required-resource-accesses '[
        {
            "resourceAppId": "[API-APP-ID]",
            "resourceAccess": [
                {
                    "id": "[SCOPE-ID]",
                    "type": "Scope"
                }
            ]
        },
        {
            "resourceAppId": "00000003-0000-0000-c000-000000000000",
            "resourceAccess": [
                {
                    "id": "e1fe6dd8-ba31-4d61-89e7-88639da4683d",
                    "type": "Scope"
                }
            ]
        }
    ]'
```

#### 2.3 Configura√ß√£o de Permiss√µes Microsoft Graph
- User.Read (para perfil b√°sico)
- User.ReadBasic.All (para listar usu√°rios da organiza√ß√£o)
- Directory.Read.All (para informa√ß√µes do diret√≥rio)

---

### **Fase 3: Implementa√ß√£o do Backend (ASP.NET Core)**

#### 3.1 Estrutura do Projeto
```
SecureDocManager.API/
‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îú‚îÄ‚îÄ AuthController.cs
‚îÇ   ‚îú‚îÄ‚îÄ DocumentsController.cs
‚îÇ   ‚îî‚îÄ‚îÄ UsersController.cs
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îú‚îÄ‚îÄ IDocumentService.cs
‚îÇ   ‚îú‚îÄ‚îÄ DocumentService.cs
‚îÇ   ‚îú‚îÄ‚îÄ IKeyVaultService.cs
‚îÇ   ‚îú‚îÄ‚îÄ KeyVaultService.cs
‚îÇ   ‚îú‚îÄ‚îÄ IGraphService.cs
‚îÇ   ‚îî‚îÄ‚îÄ GraphService.cs
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îú‚îÄ‚îÄ Document.cs
‚îÇ   ‚îú‚îÄ‚îÄ User.cs
‚îÇ   ‚îî‚îÄ‚îÄ DTOs/
‚îú‚îÄ‚îÄ Data/
‚îÇ   ‚îî‚îÄ‚îÄ ApplicationDbContext.cs
‚îî‚îÄ‚îÄ Program.cs
```

#### 3.2 Configura√ß√£o Principal (Program.cs)
```csharp
// Configurar Managed Identity
builder.Services.AddAzureClients(clientBuilder =>
{
    clientBuilder.AddKeyVaultClient(new Uri("https://kv-securedocmanager.vault.azure.net/"));
    clientBuilder.AddConfigurationClient(new Uri("https://appconfig-securedocmanager.azconfig.io"));
    clientBuilder.UseCredential(new DefaultAzureCredential());
});

// Configurar Authentication
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddMicrosoftIdentityWebApi(builder.Configuration.GetSection("AzureAd"));

// Configurar Authorization
builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("AdminOnly", policy => policy.RequireRole("Admin"));
    options.AddPolicy("ManagerOrAdmin", policy => policy.RequireRole("Manager", "Admin"));
});
```

#### 3.3 Implementa√ß√£o do Key Vault Service
```csharp
public class KeyVaultService : IKeyVaultService
{
    private readonly SecretClient _secretClient;
    
    public KeyVaultService(SecretClient secretClient)
    {
        _secretClient = secretClient;
    }
    
    public async Task<string> GetSecretAsync(string secretName)
    {
        var secret = await _secretClient.GetSecretAsync(secretName);
        return secret.Value.Value;
    }
    
    public async Task<string> GetConnectionStringAsync()
    {
        return await GetSecretAsync("DatabaseConnectionString");
    }
}
```

#### 3.4 Implementa√ß√£o SAS Tokens para Blob Storage
```csharp
public class DocumentService : IDocumentService
{
    public async Task<string> GenerateDownloadUrlAsync(string documentId, string userRole)
    {
        var blobClient = GetBlobClient(documentId);
        
        var sasBuilder = new BlobSasBuilder
        {
            BlobContainerName = "documents",
            BlobName = documentId,
            Resource = "b",
            ExpiresOn = DateTimeOffset.UtcNow.AddHours(1)
        };
        
        // Diferentes permiss√µes baseadas no role
        if (userRole == "Admin" || userRole == "Manager")
        {
            sasBuilder.SetPermissions(BlobSasPermissions.Read | BlobSasPermissions.Write);
        }
        else
        {
            sasBuilder.SetPermissions(BlobSasPermissions.Read);
        }
        
        return blobClient.GenerateSasUri(sasBuilder).ToString();
    }
}
```

#### 3.5 Integra√ß√£o com Microsoft Graph
```csharp
public class GraphService : IGraphService
{
    private readonly GraphServiceClient _graphClient;
    
    public async Task<User> GetUserProfileAsync(string userId)
    {
        return await _graphClient.Users[userId]
            .Request()
            .Select(u => new { u.DisplayName, u.Mail, u.Department, u.JobTitle })
            .GetAsync();
    }
    
    public async Task<IEnumerable<User>> GetUsersInDepartmentAsync(string department)
    {
        return await _graphClient.Users
            .Request()
            .Filter($"department eq '{department}'")
            .GetAsync();
    }
}
```

---

### **Fase 4: Implementa√ß√£o do Frontend (React + MSAL)**

#### 4.1 Configura√ß√£o MSAL
```javascript
// src/authConfig.js
export const msalConfig = {
    auth: {
        clientId: "YOUR-SPA-CLIENT-ID",
        authority: "https://login.microsoftonline.com/YOUR-TENANT-ID",
        redirectUri: "http://localhost:3000"
    },
    cache: {
        cacheLocation: "sessionStorage",
        storeAuthStateInCookie: false,
    }
};

export const loginRequest = {
    scopes: ["api://securedocmanager-api/access_as_user", "User.Read"]
};
```

#### 4.2 Componente de Autentica√ß√£o
```javascript
// src/components/AuthWrapper.js
import { useMsal } from "@azure/msal-react";

const AuthWrapper = ({ children }) => {
    const { instance, accounts } = useMsal();
    
    const handleLogin = () => {
        instance.loginPopup(loginRequest);
    };
    
    if (accounts.length === 0) {
        return (
            <div>
                <button onClick={handleLogin}>Login com Microsoft</button>
            </div>
        );
    }
    
    return children;
};
```

#### 4.3 Hook para Chamadas de API
```javascript
// src/hooks/useApiCall.js
export const useApiCall = () => {
    const { instance, accounts } = useMsal();
    
    const callApi = async (url, options = {}) => {
        const request = {
            scopes: ["api://securedocmanager-api/access_as_user"],
            account: accounts[0]
        };
        
        const response = await instance.acquireTokenSilent(request);
        
        return fetch(url, {
            ...options,
            headers: {
                ...options.headers,
                'Authorization': `Bearer ${response.accessToken}`
            }
        });
    };
    
    return { callApi };
};
```

---

### **Fase 5: Implementa√ß√£o de Managed Identity**

#### 5.1 Configura√ß√£o no App Service
```bash
# Habilitar System Assigned Managed Identity
az webapp identity assign \
    --name app-securedocmanager \
    --resource-group rg-securedocmanager

# Dar permiss√µes ao Key Vault
az keyvault set-policy \
    --name kv-securedocmanager \
    --object-id [MANAGED-IDENTITY-OBJECT-ID] \
    --secret-permissions get list

# Dar permiss√µes ao App Configuration
az role assignment create \
    --assignee [MANAGED-IDENTITY-OBJECT-ID] \
    --role "App Configuration Data Reader" \
    --scope /subscriptions/[SUB-ID]/resourceGroups/rg-securedocmanager/providers/Microsoft.AppConfiguration/configurationStores/appconfig-securedocmanager
```

#### 5.2 C√≥digo para Usar Managed Identity
```csharp
// Configura√ß√£o no Program.cs
builder.Configuration.AddAzureAppConfiguration(options =>
{
    options.Connect(new Uri("https://appconfig-securedocmanager.azconfig.io"), 
                   new DefaultAzureCredential())
           .UseFeatureFlags();
});

// Configura√ß√£o do Key Vault
builder.Configuration.AddAzureKeyVault(
    new Uri("https://kv-securedocmanager.vault.azure.net/"),
    new DefaultAzureCredential());
```

---

### **Fase 6: Funcionalidades Avan√ßadas**

#### 6.1 Assinatura Digital de Documentos
```csharp
public class DocumentSigningService
{
    private readonly KeyVaultService _keyVaultService;
    
    public async Task<byte[]> SignDocumentAsync(byte[] document, string certificateName)
    {
        var certificate = await _keyVaultService.GetCertificateAsync(certificateName);
        
        // Implementar assinatura digital usando o certificado do Key Vault
        using var rsa = certificate.GetRSAPrivateKey();
        var signature = rsa.SignData(document, HashAlgorithmName.SHA256, RSASignaturePadding.Pkcs1);
        
        return signature;
    }
}
```

#### 6.2 Auditoria de Acessos
```csharp
public class AuditService
{
    public async Task LogAccessAsync(string userId, string documentId, string action)
    {
        var auditLog = new AuditLog
        {
            UserId = userId,
            DocumentId = documentId,
            Action = action,
            Timestamp = DateTime.UtcNow,
            IpAddress = GetClientIpAddress()
        };
        
        await _context.AuditLogs.AddAsync(auditLog);
        await _context.SaveChangesAsync();
    }
}
```

---

## üß™ Cen√°rios de Teste

### Teste 1: Autentica√ß√£o e Autoriza√ß√£o
- [ ] Login com diferentes tipos de usu√°rio
- [ ] Acesso a recursos baseado em roles
- [ ] Renova√ß√£o autom√°tica de tokens

### Teste 2: Gest√£o de Documentos
- [ ] Upload com valida√ß√£o de tipo de arquivo
- [ ] Download com SAS token tempor√°rio
- [ ] Acesso negado para usu√°rios n√£o autorizados

### Teste 3: Integra√ß√£o Microsoft Graph
- [ ] Busca de informa√ß√µes do usu√°rio
- [ ] Listagem de colegas do mesmo departamento

### Teste 4: Seguran√ßa
- [ ] Secrets sendo lidos do Key Vault
- [ ] Configura√ß√µes sendo lidas do App Configuration
- [ ] Managed Identity funcionando sem credenciais hardcoded

---

## üìö Estrutura do Reposit√≥rio GitHub

```
SecureDocManager/
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ setup-guide.md
‚îÇ   ‚îú‚îÄ‚îÄ architecture.md
‚îÇ   ‚îî‚îÄ‚îÄ api-documentation.md
‚îú‚îÄ‚îÄ infrastructure/
‚îÇ   ‚îú‚îÄ‚îÄ azure-resources.bicep
‚îÇ   ‚îî‚îÄ‚îÄ deployment-scripts/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ SecureDocManager.API/
‚îÇ   ‚îú‚îÄ‚îÄ SecureDocManager.Web/
‚îÇ   ‚îî‚îÄ‚îÄ SecureDocManager.Tests/
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ ci-cd.yml
‚îÇ       ‚îî‚îÄ‚îÄ infrastructure.yml
‚îî‚îÄ‚îÄ docker/
    ‚îú‚îÄ‚îÄ Dockerfile.api
    ‚îî‚îÄ‚îÄ Dockerfile.web
```

---

## üéì Pontos de Aprendizado para AZ-204

### ‚úÖ Implementar autentica√ß√£o e autoriza√ß√£o de usu√°rio
- **Aplicado:** Sistema completo de login com Microsoft Entra ID
- **Conceitos:** JWT tokens, Claims, Roles, Policies

### ‚úÖ Microsoft Identity Platform
- **Aplicado:** MSAL.js no frontend, Microsoft.Identity.Web no backend
- **Conceitos:** OAuth 2.0, OpenID Connect, Token lifecycle

### ‚úÖ Shared Access Signatures
- **Aplicado:** URLs tempor√°rias para download de documentos
- **Conceitos:** Time-based access, Permission levels, Blob SAS

### ‚úÖ Microsoft Graph
- **Aplicado:** Busca de perfil do usu√°rio e informa√ß√µes organizacionais
- **Conceitos:** Graph SDK, Scoped permissions, Batch requests

### ‚úÖ App Configuration & Key Vault
- **Aplicado:** Configura√ß√µes din√¢micas e secrets seguros
- **Conceitos:** Configuration management, Secret rotation, Feature flags

### ‚úÖ Managed Identity
- **Aplicado:** Acesso sem credenciais a recursos Azure
- **Conceitos:** System vs User assigned, Role assignments, DefaultAzureCredential

---

## üöÄ Pr√≥ximos Passos

1. **Semana 1-2:** Configurar infraestrutura Azure e Entra ID
2. **Semana 3-4:** Implementar backend com autentica√ß√£o
3. **Semana 5:** Desenvolver frontend com MSAL
4. **Semana 6:** Integrar Key Vault e App Configuration
5. **Semana 7:** Implementar Microsoft Graph
6. **Semana 8:** Testes, documenta√ß√£o e deploy

Este projeto te dar√° experi√™ncia hands-on com todos os t√≥picos de seguran√ßa da AZ-204, criando um portf√≥lio s√≥lido para sua certifica√ß√£o!